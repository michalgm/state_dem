GraphImage("GraphSVG",{},{init:function(e){this.zoomlevels=8;this.zoom_delta=1.2;this.default_zoom=1;this.current_zoom=this.default_zoom;this.zoomSliderAxis="horizontal";this.fadeTo=.3;this._super(e);if(this.NodeViz.options.useSVG!=1)return;$("#"+this.graphdiv).append(this.zoomControlsHTML);$("#zoomin").click($.proxy(function(e){this.zoom("in")},this));$("#zoomout").click($.proxy(function(e){this.zoom("out")},this));$("#zoomreset").click($.proxy(function(e){this.zoom("reset")},this));this.zoomlevels=parseFloat(this.zoomlevels);var t=0,n=new Array,r="";while(t<=this.zoomlevels){var i=t+1;while(i<=this.zoomlevels){r+=".zoom_"+t+" .zoom_"+i+", ";i++}n.unshift(t);t++}r=r.slice(0,-2);r+=" { display: none; }";$("head").append($("<style type='text/css'/>").html(r));this.zoomSlider={value:1};$("#zoomSlider").slider({animate:"fast",orientation:this.zoomSliderAxis,max:this.zoomlevels,value:this.default_zoom,change:$.proxy(function(e,t){this.setZoomValue(t.value)},this)})},reset:function(){this._super();this.state="";this.stateOrigin="";this.clickPoint="";this.current_zoom=1;this.previous_zoom=1;this.root&&$(this.root).unbind();$(".node",".edge","#svg","#graphs","#svgscreen","#images").unbind()},render:function(e){this._super(e);var t=e.image,n=e.overlay;try{$.parseXML(n)}catch(r){this.NodeViz.reportError(900,"The SVG image is not valid XML");return}n=n.replace("<div id='svg_overlay' style='display: none'>","");n=n.replace("</div>","");n.match(/<svg width=\"([\d\.]+)px\" height=\"([\d\.]+)px\"/);this.graphWidth=RegExp.$1;this.graphHeight=RegExp.$2;n=n.replace(/<svg width=\"[\d\.]+px\" height=\"[\d\.]+px\"/,'<svg width="'+this.graphDimensions.width+'" height="'+this.graphDimensions.height+'"');var i=new DOMParser;i.async=!1;var s=i.parseFromString(n,"text/xml");$("#images").html("<div id='image'/>");$("#image").append($("#image")[0].ownerDocument.importNode(s.firstChild,!0));$("#svgscreen").attr("id","underlay_svgscreen");$("#image>svg").svg();var o=$("#image>svg").svg("get");$("#images g").each(function(e,t){$(t).attr("id","underlay_"+$(t).attr("id"))});$("#images").append($("<div/>").attr("id","svg_overlay"));$("#svg_overlay").append($("#svg_overlay")[0].ownerDocument.importNode(s.firstChild,!0));$("#image g, #svg_overlay g").each(function(e,t){var n=$("#a_"+$(t).attr("id"));n.length&&n.contents().unwrap()});this.root=$("#svg_overlay")[0].childNodes[0];this.updateCTM();var u=this.root.createSVGPoint();u.x=(this.graphDimensions.width-this.graphWidth)/2;u.y=(this.graphDimensions.height-this.graphHeight)/2;u.matrixTransform(this.stateTf);var a=this.ctm;a.e+=u.x;a.f+=u.y;var f=this.matrixToTransform(a);$("#graph0").attr("transform",f);$("#underlay_graph0").attr("transform",f);this.updateCTM();$("#svg_overlay").css("position","absolute");$("#svg_overlay").css("top","0px");$("#graph0").css("opacity","1");$("#svg_overlay").css("visibility","visible");$("#svg_overlay").css("display","block");this.setupListeners();this.zoom(this.default_zoom);this.default_zoom==1&&this.setZoomFilters()},setupListeners:function(){this._super();$("#svg_overlay").mousemove($.proxy(this.mousemove,this));$("#graphs").mousemove($.proxy(this.mousemove,this));$("#svg_overlay .node").each($.proxy(function(e,t){var n=t.id,r=this.NodeViz.data.nodes[t.id];$("#"+n).addClass(r.type);$("#underlay_"+n).addClass(r.type);if(typeof r["zoom"]!="undefined"){$("#"+n).addClass("zoom_"+r.zoom);$("#underlay_"+n).addClass("zoom_"+r.zoom)}r["class"]&&$(r.class.split(" ")).each(function(e,t){$("#"+n).addClass(t);$("#underlay_"+n).addClass(t)});this.formatLabels(t,r);t.childNodes[1]&&this.NodeViz.addEvents(t,r,"node","svg")},this));$("#svg_overlay .edge").each($.proxy(function(e,t){var n=t.id,r=this.NodeViz.data.edges[n];$("#"+n).addClass(r.type);$("#underlay_"+n).addClass(r.type);if(typeof r["zoom"]!="undefined"){$("#"+n).addClass("zoom_"+r.zoom);$("#underlay_"+n).addClass("zoom_"+r.zoom)}r["class"]&&r["class"].split(" ").each(function(e,t){$("#"+n).addClass(t);$("#underlay_"+n).addClass(t)},this);this.formatLabels(t,r);this.NodeViz.addEvents(t,r,"edge","svg")},this));this.setupZoomListeners(this.root)},highlightNode:function(e,t,n,r){if(this.state!="")return;this._super(e,t,n,r);$("#"+e+", #underlay_"+e).children().filter("polygon, ellipse").addClass("nhighlight");this.NodeViz.current.network;this.showSVGElement($("#"+e))},unhighlightNode:function(e){this._super(e);var t=this.NodeViz,n=$("#"+e);$("#"+e+", #underlay_"+e).children().filter("polygon, ellipse").removeClass("nhighlight");if(t.current["network"]==e||t.data.nodes[t.current.network]&&t.data.nodes[t.current.network].relatedNodes[e])return;this.hideSVGElement(n)},showNetwork:function(e){var t=$("#"+e);if(!t)return;if(this.NodeViz.current["network"]==t.id){this.hideNetwork();this.highlightNode(t.id);return}this.NodeViz.current.edge&&this.hideEdge(1);this.NodeViz.current.network&&this.hideNetwork(1);$("image").getOpacity()==1&&new Effect.Opacity("image",{from:1,to:this.fadeTo,duration:.5});this.showSVGElement(t);$H(nodelookup[t.id].edges).keys().each(function(e,t){this.showSVGElement($("#"+t))},this);$H(nodelookup[t.id].lnodes).keys().each(function(e,t){this.showSVGElement($("#"+t))},this);this.NodeViz.current.network=t.id},showSVGElement:function(e){if(!e)return;e.css("opacity",1).css("display","block");return e},hideSVGElement:function(e){if(!e)return;e.css("opacity","").css("display","");return e},selectNode:function(e){this._super(e);this.showSVGElement($("#"+e));$("#"+e).addClass("selected");$("#underlay_"+e).addClass("selected");$("#image").css("opacity")==1&&$("#image").fadeTo(500,this.fadeTo);$(Object.keys(this.NodeViz.data.nodes[e].relatedNodes)).each($.proxy(function(t,n){this.showSVGElement($("#"+n));$("#"+n).addClass("oselected");$("#underlay_"+n).addClass("oselected");$(this.NodeViz.data.nodes[e].relatedNodes[n]).values().each($.proxy(function(e,t){this.showSVGElement($("#"+t))},this))},this))},findParents:function(e,t){$H(this.NodeViz.data.nodes[e].relatedNodes).keys().each(function(n,r){$H(this.NodeViz.data.nodes[e].relatedNodes[r]).values().each(function(n,r){if(this.NodeViz.data.edges[r].toId==e){t.push(this.NodeViz.data.edges[r].fromId);t=this.NodeViz.renderers.GraphImage.findParents(this.NodeViz.data.edges[r].fromId,t)}},this)},this);return t},findParentEdges:function(e,t){$H(this.NodeViz.data.nodes[e].relatedNodes).keys().each(function(n,r){$H(this.NodeViz.data.nodes[e].relatedNodes[r]).values().each(function(n,r){if(this.NodeViz.data.edges[r].toId==e){t.push(r);t=this.NodeViz.renderers.GraphImage.findParentEdges(this.NodeViz.data.edges[r].fromId,t)}},this)},this);return t},findChildren:function(e,t){$H(this.NodeViz.data.nodes[e].relatedNodes).keys().each(function(n,r){$H(this.NodeViz.data.nodes[e].relatedNodes[r]).values().each(function(n,r){if(this.NodeViz.data.edges[r].fromId==e){t.push(this.NodeViz.data.edges[r].toId);t=this.NodeViz.renderers.GraphImage.findChildren(this.NodeViz.data.edges[r].toId,t)}},this)},this);return t},findChildEdges:function(e,t){$H(this.NodeViz.data.nodes[e].relatedNodes).keys().each(function(n,r){$H(this.NodeViz.data.nodes[e].relatedNodes[r]).values().each(function(n,r){if(this.NodeViz.data.edges[r].fromId==e){t.push(r);t=this.NodeViz.renderers.GraphImage.findChildEdges(this.NodeViz.data.edges[r].toId,t)}},this)},this);return t},unselectNode:function(e,t){this._super(e,t);var n=$.proxy(function(){var t=$("#"+e);t.removeClass("selected");$("#underlay_"+e).removeClass("selected");$(this.NodeViz.data.nodes[e].relatedNodes).keys().each($.proxy(function(t,n){var r=$("#"+n);this.hideSVGElement(r);r.removeClass("oselected");$("#underlay_"+n).removeClass("oselected");$(this.NodeViz.data.nodes[e].relatedNodes[n]).values().each($.proxy(function(e,t){this.hideSVGElement($("#"+t))},this))},this));this.hideSVGElement(t);this.unhighlightNode(e);$("#svg_overlay").css("opacity",1)},this);if(t){$("#image").fadeTo(300,1);$("#svg_overlay").fadeTo(300,0,n)}else n()},hasClassName:function(e,t){var n=e.getAttribute("class")||"";return n.length>0&&(n==t||(new RegExp("(^|\\s)"+t+"(\\s|$)")).test(n))},addClassName:function(e,t){var n=e.getAttribute("class")||"";this.hasClassName(e,t)||(n+=(n?" ":"")+t);e.setAttribute("class",n);return e},removeClassName:function(e,t){elementClassName=e.getAttribute("class");elementClassName=elementClassName.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," ").strip();e.setAttribute("class",elementClassName);return e},zoomToNode:function(e,t){if(!$(e))return;var n=this.ctm,r=$("#"+e).children()[0].getBBox(),i=this.root.createSVGPoint();i.x=r.width/2+r.x;i.y=r.height/2+r.y;var s=i.matrixTransform(n),o=$("#svg_overlay").offset();s.x-=o.left;s.y-=o.top;t=typeof t!="undefined"?t:"in";this.zoom(t,s)},getElementCenter:function(e){if(!$("#"+e).length)return;var t=$("#"+e).children()[0].getBBox(),n=this.root.createSVGPoint();n.x=t.width/2+t.x;n.y=t.height/2+t.y;var r=this.calculateCenter();r=r.matrixTransform(this.stateTf);var i=this.root.createSVGPoint();i.x=r.x-n.x;i.y=r.y-n.y;return i},panToNode:function(e,t,n){var r=this.getElementCenter(e);if(n&&typeof n.x!="undefined"){var i=r.matrixTransform(this.ctm);i.x+=n.x;i.y+=n.y;r=i.matrixTransform(this.stateTf)}var s=this.matrixToTransform(this.ctm.translate(r.x,r.y));$("#graph0, #underlay_graph0").animate({svgTransform:s},1e3,$.proxy(function(){this.updateCTM();if(typeof t!="undefined")if(n&&typeof n.x!="undefined"){var e=this.calculateCenter();e.x+=n.x;e.y+=n.y;this.zoom(t,e)}else this.zoom(t,this.calculateCenter())},this))},setupZoomListeners:function(e){Hammer(e,{transform_always_block:!0}).on("dragstart dragend drag transform doubletap",$.proxy(function(e){e.gesture?e.gesture.preventDefault():e.preventDefault();switch(e.type){case"dragstart":this.handleMouseDown(e);break;case"dragend":this.handleMouseUp(e);break;case"drag":this.handleMouseMove(e);break;case"transform":this.handleMouseWheel(e,e.gesture.scale);break;case"doubletap":(!$(e.target).closest("#graph0").length||e.target.id=="svgscreen")&&this.zoom("in",this.getEventPoint(e))}e.stopPropagation()},this));$("#svgscreen").unbind("click");$("#images").mouseleave($.proxy(function(e){this.handleMouseUp(e)},this));$(e).mousewheel($.proxy(function(e,t){this.handleMouseWheel(e,t)},this));this.center=this.calculateCenter()},getEventPoint:function(e){var t=this.root.createSVGPoint();e.gesture&&(e=e.gesture.center);t.x=e.pageX;t.y=e.pageY;var n=[$("#svg_overlay").offset().left,$("#svg_overlay").offset().top];t.x=t.x-n[0];t.y=t.y-n[1];return t},setCTM:function(e){var t="matrix("+e.a+","+e.b+","+e.c+","+e.d+","+e.e+","+e.f+")";$("#graph0, #underlay_graph0").attr("transform",t);if(this.zoomSlider.value!=this.current_zoom){this.zoomSlider.value=this.current_zoom;this.setZoomValue(this.zoomSlider.value);this.setZoomFilters()}this.updateCTM()},setZoomFilters:function(){$("#image, #svg_overlay").removeClass("zoom_"+this.previous_zoom).addClass("zoom_"+this.zoomSlider.value)},dumpMatrix:function(e){var t="[ "+e.a+", "+e.c+", "+e.e+"\n  "+e.b+", "+e.d+", "+e.f+"\n  0, 0, 1 ]";return t},setAttributes:function(e,t){for(i in t)e.setAttributeNS(null,i,t[i])},handleMouseWheel:function(e,t){if(this.state=="zoom")return;e.preventDefault&&e.preventDefault();e.returnValue=!1;var n=this.getEventPoint(e),r=e.gesture?1:0;t>r?this.zoom("in",n):this.zoom("out",n)},handleMouseMove:function(e){e.preventDefault&&e.preventDefault();e.returnValue=!1;var t=$("#graph0");if(this.state=="pan"){var n=this.getEventPoint(e).matrixTransform(this.stateTf);this.setCTM(this.ctm.translate(n.x-this.stateOrigin.x,n.y-this.stateOrigin.y))}},handleMouseDown:function(e){e.preventDefault&&e.preventDefault();e.returnValue=!1;var t=this.root;e.target.id!="svgscreen"&&e.target.tagName!="svg_overlay"&&e.target.tagName!="svg";var n=$("#graph0")[0];this.state="pan";$(e.target).css("cursor","move");$("#svgscreen").css("cursor","move");this.stateOrigin=this.getEventPoint(e).matrixTransform(this.stateTf);this.clickPoint=this.getEventPoint(e)},handleMouseUp:function(e){e.preventDefault&&e.preventDefault();e.returnValue=!1;var t=this.getEventPoint(e);this.clickPoint.x==t.x&this.clickPoint.y==t.y&(e.target.id=="svgscreen"||e.target.tagName=="svg_overlay"||e.target.tagName=="svg")&&this.NodeViz.unselectNode(1);if(this.state=="pan"){$("#graph0").css("display","");$(e.target).css("cursor","");this.state=""}},zoom:function(e,t){if(e=="in")e=this.zoomSlider.value+1;else if(e=="out")e=this.zoomSlider.value-1;else if(e=="reset"){this.NodeViz.panToNode("graph0",this.default_zoom);return}if(e<0||e>this.zoomlevels)return;t&&(this.zoom_point=t);this.setZoomValue(e,t)},setZoomValue:function(e,t){if(this.state=="zoom"||this.current_zoom==e)return;this.zoom_event&&window.clearTimeout(this.zoom_event);this.state="zoom";var n=window.setTimeout($.proxy(function(){$("#zoomSlider").slider("value",e);this.previous_zoom=this.current_zoom;this.current_zoom=e;this.zoomSlider.value=e;var n=e-this.previous_zoom,r=Math.pow(this.zoom_delta,n);this.SVGzoom(r,t)},this),100)},SVGzoom:function(e,t){$("#"+this.graphdiv).addClass("zooming");t||(t=this.calculateCenter());var n=t.matrixTransform(this.stateTf),r=this.matrixToTransform(this.ctm.translate(n.x,n.y).scale(e).translate(-n.x,-n.y));$("#graph0").animate({svgTransform:r},500);$("#underlay_graph0").animate({svgTransform:r},500,$.proxy(function(){this.setZoomFilters();$("#"+this.graphdiv).removeClass("zooming");this.updateCTM();this.NodeViz.afterZoom&&this.NodeViz.afterZoom();this.state=""},this));this.zoom_point=null},calculateCenter:function(){var e=this.root.createSVGPoint();e.x=$("#svg_overlay").position().left+$("#svg_overlay").width()/2;e.y=$("#svg_overlay").position().top+$("#svg_overlay").height()/2;return e},formatLabels:function(e,t){var n=e.getElementsByTagName("text")[0],r=$("#underlay_"+t.id+" text")[0];if(n){this.addClassName(n,"label");this.addClassName(r,"label");if(typeof t["label_zoom_level"]!="undefined"){this.addClassName(n,"zoom_"+t.label_zoom_level);this.addClassName(r,"zoom_"+t.label_zoom_level)}if(typeof t["label_offset_x"]!="undefined"){var i=parseFloat(t.label_offset_x*this.stateTf.a)+parseFloat(n.getAttribute("x"));n.setAttribute("x",i);r.setAttribute("x",i)}if(typeof t["label_offset_y"]!="undefined"){var s=parseFloat(t.label_offset_y*this.stateTf.d)+parseFloat(n.getAttribute("y"));n.setAttribute("y",s);r.setAttribute("y",s)}if(typeof t["label_text_anchor"]!="undefined"){n.setAttribute("text-anchor",t.label_text_anchor);r.setAttribute("text-anchor",t.label_text_anchor)}}},resize:function(){if(this.state=="resize")return;this.resize_event&&window.clearTimeout(this.resize_event);this.state="resize";this._parent_resize=this._super;this.resize_event=window.setTimeout($.proxy(function(){var e=this.graphDimensions,t=this.getElementCenter("graph0");this._parent_resize();$("#svg_overlay, #image").each($.proxy(function(e,t){if(t){t.childNodes[0].setAttribute("height",this.graphDimensions.height);t.childNodes[0].setAttribute("width",this.graphDimensions.width)}},this));var n=this.calculateCenter();$("#graph0").length&&this.updateCTM();var r=this.graphDimensions,i=e.width<e.height?"width":"height",s=r.width<r.height?"width":"height",o=r[s]/e[i],u=this.getElementCenter("graph0"),a=this.setCTM(this.ctm.translate(u.x,u.y).scale(o).translate(-u.x,-u.y)),f=this.getElementCenter("graph0");this.setCTM(this.ctm.translate(f.x-t.x,f.y-t.y));this.state="";delete this._parent_resize},this),200)},updateCTM:function(){var e=$("#graph0")[0].getCTM();if(e){this.ctm=e;this.stateTf=e.inverse()}},matrixToTransform:function(e){return"matrix("+e.a+","+e.b+","+e.c+","+e.d+","+e.e+","+e.f+")"},zoomControlsHTML:"		<div id='zoomcontrols'>			<span id='zoomin' class='zoomin' alt='Zoom In' title='Zoom In'>[+]</span>			<div id='zoomSlider' class='slider'></div>			<span id='zoomout' class='zoomout' alt='Zoom Out' title='Zoom Out'>[-]</span>			<span id='zoomreset' class='zoomreset' alt='Reset Zoom' title='Reset Zoom'>[0]</span>		</div>	"});