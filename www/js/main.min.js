// Document Ready
function initGraph(){var e=$.url().param();$(e).keys().each(function(t,n){$("#graphoptions").append($("<input>").attr({type:"hidden",name:n,value:e[n]}))});$("#graphoptions").change(writeHash);var t={setupfile:"StateDEM",disableAutoLoad:1,image:{graphdiv:"graphs",zoomlevels:"8",zoomSliderAxis:"vertical",fadeTo:.2},functions:{post_mouseenter:function(e,t,n,r,i){var s=this.renderers.GraphImage.tooltip.outerWidth()/2;this.renderers.GraphImage.tooltipOffsetX=-s;this.renderers.GraphImage.tooltipOffsetY=-20}}};remotecache&&(t.NodeVizPath=remotecache);gf=new NodeViz(t);$("#graphoptions").change($.proxy(gf.reloadGraph,gf))}function updateInfocardData(e){var t=(remotecache?remotecache+"../":"")+"request.php";$.getJSON(t,{method:"chartData",type:e.type,id:e.id,state:gf.data.properties.state,chamber:gf.data.properties.chamber},function(e,t,n){drawBarChart(e.contributionsByYear,"#node-barchart")})}function selectNode(e){gf.selectNode(e.id);current_network=e.id;writeHash(1);toggleInfocard(e)}function toggleInfocard(e){var t=$("#infocard"),n=t.data("data-node");updateInfocardData(e);if(t.is(":hidden")||n!==e.id){t.data("data-node",e.id);switch(e.type){case"candidates":$("#node-title").html(e.title+' <span class="district '+e.party+'">'+e.district+"</span>");$("#node-amount").html("Received $"+commas(Math.floor(e.value))+" in "+gf.data.properties.cycle);break;case"donors":$("#node-title").html(e.title+' <span class="sector '+e.sitecode+'">'+e.sitecode+"</span>");$("#node-amount").html("Contributed $"+commas(Math.floor(e.value))+" to the "+gf.data.properties.state+" "+$("#chamber :selected").text()+" in "+gf.data.properties.cycle)}$("#node-total").html("Total: $"+commas(e.lifetime_total));var r=(remotecache?remotecache+"../":"")+"request.php";$("#node-csvlink a").attr("href",r+"?method=csv&type="+e.type+"&id="+e.id+"&state="+gf.data.properties.state+"&chamber="+gf.data.properties.chamber);t.slideDown(500);gf.panToNode(e.id,4,{y:-50,x:0});$("#legend").hide()}else resetGraph()}function toggleMore(){$("#infocard").toggleClass("open");$("#node-amount, .node-more").fadeToggle()}function togglePage(e){var t=$(e).attr("href")||"";$(".page").not(t).slideUp();$(t).slideToggle()}function resetGraph(){$("#infocard").removeClass("open").slideUp(500,function(){$("#node-amount").show();$(".node-more").hide();current_network="";gf.current.network&&gf.unselectNode(1);gf.zoom("reset")});$("#legend").fadeIn(2e3)}function writeHash(e){var t={state:$("#state").val(),chamber:toWordCase($("#chamber").val().replace("state:","")),cycle:$("#cycle").val()},n=[t.state,t.chamber,t.cycle];if(e==1){t.network=gf.current.network;n.push(t.network)}else current_network="";History.pushState(t,"Dirty Energy Money - States - "+$("#state option:selected").text(),"?"+n.join("/"))}function setState(){var e=History.getState().data;if(!e.state)resetGraph();else{e.chamber="state:"+e.chamber.toLowerCase();if($("#state").val()!=e.state||$("#chamber").val()!=e.chamber||$("#cycle").val()!=e.cycle){$("#state").val(e.state);$("#chamber").val(e.chamber);$("#cycle").val(e.cycle);$("#state").change()}else if(current_network!=e.network||!e.network)if(!e.network&&current_network)resetGraph();else if(e.network&&gf.data.nodes[e.network]){current_network=e.network;$("#"+e.network).click()}}}function drawBarChart(e,t){var n=15,r=$(window).width(),i=$(window).height()/2-150,s=d3.scale.ordinal().rangeRoundBands([0,r],.05),o=d3.scale.linear().range([0,i-n*2]),u=d3.select(t+" svg>g");u.empty()&&(u=d3.select(t).append("svg").attr("width",r).attr("height",i).append("svg:g").attr("transform","translate(0, "+(i-n)+")"));if(typeof e[0]=="undefined"){$(t+" svg").remove();return}var a=$(e[0]).keys().map(function(e,t){if(t!="value"&&t!="label")return t}).toArray(),f=d3.layout.stack().offset("zero")(a.map(function(t){return e.map(function(e){return{x:e.label,y:+e[t],label:t}})}));s.domain(f[0].map(function(e){return e.x}));o.domain([0,d3.max(e,function(e){return parseInt(e.value)})]);var l=u.selectAll("g.category").data(f);l.enter().append("svg:g").attr("class",function(e){return"category "+e[0].label});l.transition().attr("class",function(e){return"category "+e[0].label});var c=l.selectAll("rect").data(function(e){return e},function(e){return e.x});c.enter().append("svg:rect").attr("x",function(e){return s(e.x)}).attr("y",0).attr("height",0).attr("width",s.rangeBand()).style("opacity","0");c.transition().duration(1e3).delay(!c.exit().empty()*200).attr("x",function(e){return s(e.x)}).attr("y",function(e){return-o(e.y0)-o(e.y)}).attr("height",function(e){return o(e.y)}).attr("width",s.rangeBand()).style("opacity","1");c.exit().transition().duration(200).attr("height",0).attr("y",0).style("opacity","0").remove();var h=u.selectAll("g.amounts").data(f);h.enter().append("svg:g").attr("class","amounts");var p=h.selectAll(".amount").data(function(e){return e},function(e){return e.x});p.enter().append("text").attr("class","chart-label amount").attr("dominant-baseline","middle").attr("text-anchor","middle").attr("y",function(e){return 0+o(e.y)/2}).style("fill","#fff").style("opacity","0");p.transition().delay(!p.exit().empty()*200).duration(1e3).style("opacity","1").attr("x",function(e){return s(e.x)+s.rangeBand()/2}).attr("y",function(e){return-o(e.y0)-o(e.y)+o(e.y)/2}).attr("width",function(){return s.rangeBand()}).tween("text",function(e){var t=d3.interpolate(this.textContent.replace(/[^0-9]+/g,""),e.y);return function(r){if(o(e.y)>n-2){var i={carbon:"Miscellaneous",DEM:"Democrats",REP:"Republicans",IND:"Independants"},s=i[e.label]?i[e.label]:e.label;this.textContent=toWordCase(s)+": $"+commas(Math.floor(t(r)))}else this.textContent=""}});p.exit().transition().duration(200).attr("y",function(e){return 0+o(e.y)/2}).style("opacity","0").remove();var d=u.selectAll(".year").data(e,function(e){return e.label});d.enter().append("text").attr("x",function(e,t){return s(e.label)+s.rangeBand()/2}).attr("class","chart-label year").attr("y",0).text(function(e,t){return e.label}).attr("width",function(){return s.rangeBand()}).attr("text-anchor","middle").style("opacity","0").attr("dominant-baseline","text-before-edge");d.transition().delay(!d.exit().empty()*200).duration(1e3).attr("x",function(e,t){return s(e.label)+s.rangeBand()/2}).style("opacity","1");d.exit().transition().duration(200).style("opacity","0").remove();var v=u.selectAll(".total").data(e,function(e){return e.label});v.enter().append("text").attr("x",function(e,t){return s(e.label)+s.rangeBand()/2}).attr("class","chart-label total").attr("y",function(e){return-o(e.value)-n}).attr("dominant-baseline","text-before-edge").attr("width",function(){return s.rangeBand()}).attr("text-anchor","middle").style("opacity","0");v.transition().delay(!v.exit().empty()*200).duration(1e3).attr("x",function(e,t){return s(e.label)+s.rangeBand()/2}).attr("y",function(e){return-o(e.value)-n}).style("opacity","1").tween("text",function(e){var t=d3.interpolate(this.textContent.replace(/[^0-9]+/g,""),e.value);return function(e){this.textContent="$"+commas(Math.floor(t(e)))}});v.exit().transition().duration(200).style("opacity","0").remove()}function drawPieChart(e,t){function h(){path=l.datum(e).selectAll("path").data(u,d);path.transition().duration(750).attrTween("d",p).attr("fill",function(e,t){return n[e.data.label][1]});l.datum(e).selectAll("text").data(u,d).attr("transform",function(e){return"translate("+a.centroid(e)+")"+"rotate("+f(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return n[e.data.label][0]})}function p(e){var t=d3.interpolate(this._current,e);this._current=t(0);return function(e){return a(t(e))}}function d(e){var t=typeof e.label!="undefined"?e.label:e.data.label;t=="coal"?t="D":t=="oil"?t="R":t=="carbon"&&(t="N");return t}var n={oil:["Oil","#6D8F9D"],coal:["Coal","#958D63"],carbon:["Carbon","#6E6E6E"],R:["Republican","#cc3333"],D:["Democrat","#3333cc"],G:["Green","#33cc33"],L:["Libertarian","#cc33cc"],I:["Independant","#cccc33"],N:["Non-Partisan","#cccccc"]},r=$(window).width()/2*.9,i=$(window).height()/2*.675,s=Math.min(r,i)/2,o=d3.scale.category20(),u=d3.layout.pie().value(function(e){return e.value}).sort(d),a=d3.svg.arc().innerRadius(s*.25).outerRadius(s*1),f=function(e){var t=180/Math.PI*(e.startAngle+e.endAngle)/2-90;t>90&&(t-=180);return t},l=d3.select(t+" svg>g");l.empty()&&(l=d3.select(t).append("svg").attr("width",r).attr("height",i).append("g").attr("transform","translate("+r/2+","+i/2+")"));var c=l.datum(e).selectAll(".arc").data(u,d).enter().append("g").attr("class","arc");c.append("path").attr("fill",function(e,t){return n[e.data.label][1]}).attr("d",a).each(function(e){this._current=e}).on("mouseenter",brighten).on("mouseleave",darken);c.append("text").attr("class","chart-label").attr("transform",function(e){return"translate("+a.centroid(e)+")"+"rotate("+f(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return e.data.label});l.datum(e).selectAll("path").data(u,d).exit().transition(750).attr("fill","#fff");l.datum(e).selectAll(".arc").data(u,d).exit().transition(750).remove();h()}function brighten(){var e=d3.select(this);e.attr("fill",d3.rgb(e.attr("fill")).brighter(.7))}function darken(){var e=d3.select(this);e.attr("fill",d3.rgb(e.attr("fill")).darker(.7))}function commas(e){while(/(\d+)(\d{3})/.test(e.toString()))e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}function setupOptions(){var e=$.map(states,function(e,t){return t}).sort(),t=$("#state").val();$("#state").html("");$(e).each(function(e,t){$("#state").append($("<option>").attr("value",t).html(states[t].name));$("#intro_state").append($("<option>").attr("value",t).html(states[t].name))});$("#state").val(t);$("#state").on("change",function(){updateOptions()})}function updateOptions(){var e=states[$("#state").val()],t=$("#cycle").val(),n=$("#chamber").val();$("#chamber").html("");$("#chamber").append($("<option>").attr("value","state:upper").html(e.upper_name));e.lower_name&&$("#chamber").append($("<option>").attr("value","state:lower").html(e.lower_name));$("#cycle").html("");$(e.years.split(",").reverse()).each(function(e,t){$("#cycle").append($("<option>").html(t))});$("#cycle").val(t);$("#chamber").val(n)}$(function(){current_network="";$("#close_error").click(function(){$("#error").hide()});if(!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")){$("#error").html("<h3>Unsupported Browser</h3> We're sorry - this website requires SVG, and it appears your web browser does not support it. Please consider updating to a modern, standards-compliant web browser, such as <a href='http://mozilla.org/firefox'>FireFox</a> or <a href='http://google.com/chrome'>Chrome</a>").show();return}setupOptions();History.Adapter.bind(window,"statechange",setState);initGraph();$("#infocard .close").click(function(){resetGraph()});$("#infocard .more").click(function(){toggleMore()});$(".aboutLink, .methodologyLink, .page-close").click(function(){togglePage(this)});$("#pull").click(function(e){$(".navlist").slideToggle();e.preventDefault()});$(window).resize(function(){$(window).width()>320&&$(".navlist").is(":hidden")&&$(".navlist").removeAttr("style")});var e=window.location.search.substr(1).split("/");if(e[0]){$("#state").val(e[0]);updateOptions();$("#chamber").val("state:"+e[1].toLowerCase());updateOptions();$("#cycle").val(e[2]);$("#intro_screen").hide();$("#state").change();e[3]&&(current_network=e[3])}else{$("#intro_screen").show();$("#graphoptions select").hide()}$("#intro_state").change(function(e){$("#state").val($("#intro_state").val());var t=$("#intro_screen").offset();t.margin=0;$("#intro_screen").css(t).animate({height:0,width:"20px",top:$("#navbar").position().top,left:0},250,function(){$(this).hide();$("#state").change()});$("#graphoptions select").fadeIn();$("#masthead").fadeOut()})});$.extend(NodeViz.prototype,{graphLoaded:function(){$(".cluster").remove();$.each($(".zero"),function(e,t){gf.data.nodes[t.id]&&(gf.data.nodes[t.id].relatedNodes={})});$("#infocard").hide();$("#masthead").fadeOut(2e3);$("#about, #methodology").slideUp();$("#legend-text").html("Contributions to the "+gf.data.properties.state+" "+$("#chamber :selected").text()+" in "+gf.data.properties.cycle+", scaled by amount.");gf.nodeList=$.map(gf.data.nodes,function(e){return{label:e.title,value:e.id,search_label:e.title}});$("#node_search").keyup(function(e){$("#node_search").val()==""&&$("#no_results_found").hide()});$("#node_search").keypress(function(e){var t=e.keyCode?e.keyCode:e.which;if(t==13){if($("#node_search").val().length){$("#node_search").autocomplete("search");$("#node_search").autocomplete("close")}return!1}$("#node_search").val()==""&&$("#no_results_found").hide()});$("#node_search").autocomplete({source:gf.nodeList,autoFocus:!0,appendTo:"#node_search_list",select:function(e,t){$("#node_search").val(t.item.search_label);selectNode(gf.data.nodes[t.item.value]);$("#node_search").autocomplete("close");return!1},response:function(e,t){t.content.length==0&&$("#node_search").val().length?$("#no_results_found").show():$("#no_results_found").hide()}}).data("ui-autocomplete")._renderItem=function(e,t){var n=gf.data.nodes[t.value],r,i=$("<li>");if(n.type=="candidates"){i.addClass("politician");r=n.title+" <span class='"+n.party+" searchdetails'>("+n.party+" "+n.district+")</span>"}else{i.addClass("company");r="<span>"+n.title+" <span class='"+n.sitecode+" searchdetails'>("+toWordCase(n.sitecode)+")</span></span>"}return i.append("<a>"+r+"</a>").appendTo(e)};current_network&&gf.data.nodes[current_network]&&$("#"+current_network).click()}});GraphImage.prototype.pre_render=function(e){e.overlay=e.overlay.replace(/com_images/g,"http://dirtyenergymoney.com/com_images")};NodeViz.prototype.default_events.edge.click=null;NodeViz.prototype.default_events.node.click=function(e,t,n,r,i){selectNode(n)};