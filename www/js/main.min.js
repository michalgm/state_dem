// Document Ready
function initGraph(){var e=$.url().param();$(e).keys().each(function(t,n){$("#graphoptions").append($("<input>").attr({type:"hidden",name:n,value:e[n]}))});var t={NodeVizPath:"http://styrotopia.net/~dameat/state_dem/ui-branch/state_dem/www/NodeViz/",setupfile:"StateDEM",image:{graphdiv:"graphs",zoomlevels:"8",zoomSliderAxis:"vertical"},functions:{post_mouseenter:function(e,t,n,r,i){var s=this.renderers.GraphImage.tooltip.outerWidth()/2;this.renderers.GraphImage.tooltipOffsetX=-s;this.renderers.GraphImage.tooltipOffsetY=-20},post_click:function(e,t,n,r,i){toggleInfocard(n)}}};gf=new NodeViz(t)}function updateInfocardData(e){$.getJSON("request.php",{type:e.type,id:e.id},function(e,t,n){drawPieChart(e.contributionsByCategory,"#node-piechart1");drawBarChart(e.contributionsByYear,"#node-barchart")})}function toggleInfocard(e){var t=$("#infocard"),n=t.data("data-node");updateInfocardData(e);if(t.is(":hidden")||n!==e.id){t.data("data-node",e.id);$("#node-title").html(e.label+' <span class="district '+e.party+' ">'+e.district+"</span>");var r=e.image.split("www/");$("#node-image img").attr("src",r[1]);t.slideDown(500,function(){$("#graphs").animate({top:-(t.height()/2)-50})});$("#masthead, #zoomcontrols").hide()}else resetGraph()}function resetGraph(){$("#infocard").slideUp();$("#masthead, #zoomcontrols").fadeIn(2e3);$("#graphs").css("top",0)}function drawBarChart(e,t){var n=$(t).width(),r=$(t).height(),i=d3.scale.linear().domain([0,e.length]).range([0,n]),s=d3.scale.linear().domain([0,d3.max(e,function(e){return parseInt(e.value)})]).rangeRound([0,r]),o=d3.select(t+" svg");o.empty()&&(o=d3.select(t).append("svg").attr("width",n).attr("height",r));var u=o.selectAll(".bar").data(e);u.enter().append("rect").attr("class","bar").attr("x",function(e,t){return i(t)}).attr("y",function(e){return r}).attr("width",function(){return n/e.length*.9}).attr("height",function(e){return 0});u.transition().duration(1e3).attr("x",function(e,t){return i(t)}).attr("y",function(e){return r-s(e.value)}).attr("height",function(e){return s(e.value)}).attr("width",function(){return n/e.length*.9});u.exit().transition().duration(1e3).attr("y",function(e){return r}).remove();var a=o.selectAll(".amount").data(e);a.enter().append("text").attr("class","chart-label amount");a.transition().duration(1e3).attr("x",function(t,r){return i(r)+n/e.length*.9/2}).attr("y",function(e){return r-s(e.value)}).attr("dy","2em").attr("width",function(){return n/e.length}).attr("text-anchor","middle").text(function(e){return"$"+e.value});a.exit().remove();var f=o.selectAll(".year").data(e);f.enter().append("text").attr("class","year chart-label");f.transition().duration(1e3).attr("x",function(t,r){return i(r)+n/e.length/2}).attr("y",function(e){return r}).attr("dy","-1em").attr("width",function(){return n/e.length}).attr("text-anchor","middle").text(function(e){return e.label});f.exit().remove()}function drawPieChart(e,t){function c(){path=f.datum(e).selectAll("path").data(u);path.transition().duration(750).attrTween("d",h).attr("fill",function(e,t){return n[e.data.label][1]});f.datum(e).selectAll("text").data(u).attr("transform",function(e){return"translate("+a.centroid(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return n[e.data.label][0]})}function h(e){var t=d3.interpolate(this._current,e);this._current=t(0);return function(e){return a(t(e))}}var n={oil:["Oil","#6D8F9D"],coal:["Coal","#958D63"],carbon:["Carbon","#6E6E6E"],R:["Republican","#cc3333"],D:["Democrat","#3333cc"],G:["Green","#33cc33"],L:["Libertarian","#cc33cc"],I:["Independant","#cccc33"],N:["Non-Partisan","#cccccc"]},r=$(t).width(),i=$(t).height(),s=Math.min(r,i)/2,o=d3.scale.category20(),u=d3.layout.pie().value(function(e){return e.value}).sort(null),a=d3.svg.arc().innerRadius(s*.25).outerRadius(s*1),f=d3.select(t+" svg>g");f.empty()&&(f=d3.select(t).append("svg").attr("width",r).attr("height",i).append("g").attr("transform","translate("+r/2+","+i/2+")"));var l=f.datum(e).selectAll(".arc").data(u).enter().append("g").attr("class","arc");l.append("path").attr("fill",function(e,t){return"#fff"}).attr("d",a).each(function(e){this._current=e}).on("mouseenter",brighten).on("mouseleave",darken);l.append("text").attr("class","chart-label").attr("transform",function(e){return"translate("+a.centroid(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return e.data.label});f.datum(e).selectAll(".arc").data(u).exit().remove();c()}function brighten(){var e=d3.select(this);e.attr("fill",d3.rgb(e.attr("fill")).brighter(.7))}function darken(){var e=d3.select(this);e.attr("fill",d3.rgb(e.attr("fill")).darker(.7))}$(function(){initGraph();$("#infocard").hide();$("#infocard .close").click(function(){resetGraph()});$("#pull").click(function(e){$(".navlist").slideToggle();e.preventDefault()});$(window).resize(function(){$(window).width()>320&&$(".navlist").is(":hidden")&&$(".navlist").removeAttr("style")})});$.extend(NodeViz.prototype,{graphLoaded:function(){},afterInit:function(){}});$.extend(GraphList.prototype,{listNodeEntry:function(e){var t,n="";e.label?t=e.label:t=e.id;var r="",i="<span class='chip "+(typeof e.party!="undefined"?e.party:"contrib_"+e.contributor_type)+"'></span>",s=typeof e.image!="undefined"&&e.image!="null"?"<img src='"+e.image+"' style='width: 20px; border: 1px solid #666;'/>":"";if(e.type=="candidates"){if(e.party){r="<span class='info'>"+e.party+"</span>";r+="<div class='details'>					<a class='profile_link' href='?candidate_ids="+e.id+"'><img class='link_icon' src='images/go-next.png'/>Profile</a>					<a class='nimsp_link' href='http://www.followthemoney.org/database/uniquecandidate.phtml?uc="+e.unique_candidate_id+"' target='_new'><img class='link_icon' src='images/go-next.png'/>NIMSP Profile</a>				</div>"}}else{var o="Unknown";e.industry!="--"&&(o=e.industry);r+="<a class='profile_link' href='?company_ids="+e.id+"'><img class='link_icon' src='images/go-next.png'/>Profile</a>";r+="<span class='industry'>"+o+"</span><br style='clear:both'/>"}return s+"<span class='label'>"+t+"</span><span class='amount'>$"+format(Math.round(e.total_dollars))+"</span><br/>"+i+r},listSubNodeEntry:function(e,t,n,r){var i,s=r=="to"?"to_node_item":"from_node_item";e.label?i=e.label:i=e.id;var o="Uncategorized",u=this.NodeViz.data.edges[e.relatedNodes[t.id][0]];e.type=="candidates"?e.party&&(o=e.party):e.contributor_type&&(e.contributor_type=="I"?o="Individual":e.contributor_type=="C"&&(o="PAC"));o="<span class='info'>"+o+"</span>";var a="<span class='chip "+(typeof e.party!="undefined"?e.party:"contrib_"+e.contributor_type)+"'></span>",f="<span class='details_link'><img src='NodeViz/icons/magnifier.png' alt='View Details' title='View Details'/></span>";return"<span class='"+s+" label' onclick=\"gf.selectNode('"+e.id+"'); gf.panToNode('"+e.id+"');\">"+i+"</span><span class='amount'>$"+format(Math.round(u.value))+"</span><br/>"+a+o+f},sublistHeader:function(e,t,n){var r="Recipients";n=="to"&&(r="Donors");return"<div class='sublist_header'>"+r+"</div>"}});