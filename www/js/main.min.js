// Document Ready
function initGraph(){var e=$.url().param();$(e).keys().each(function(t,n){$("#graphoptions").append($("<input>").attr({type:"hidden",name:n,value:e[n]}))});var t={setupfile:"StateDEM",image:{graphdiv:"graphs",zoomlevels:"8",zoomSliderAxis:"vertical"},functions:{post_mouseenter:function(e,t,n,r,i){var s=this.renderers.GraphImage.tooltip.outerWidth()/2;this.renderers.GraphImage.tooltipOffsetX=-s;this.renderers.GraphImage.tooltipOffsetY=-20}}};remotecache&&(t.NodeVizPath=remotecache);gf=new NodeViz(t)}function updateInfocardData(e){var t=(remotecache?remotecache+"../":"")+"request.php";$.getJSON(t,{method:"chartData",type:e.type,id:e.id,state:gf.data.properties.state,chamber:gf.data.properties.chamber},function(e,t,n){drawPieChart(e.contributionsByCategory,"#node-piechart");drawBarChart(e.contributionsByYear,"#node-barchart")})}function selectNode(e){gf.selectNode(e.id);toggleInfocard(e)}function toggleInfocard(e){var t=$("#infocard"),n=t.data("data-node");updateInfocardData(e);console.log(gf.data.properties);if(t.is(":hidden")||n!==e.id){gf.panToNode(e.id,4,{y:-50,x:0});t.data("data-node",e.id);switch(e.type){case"candidates":$("#node-title").html(e.title+' <span class="district '+e.party+'">'+e.district+"</span>");$("#node-amount").html("Received $"+commas(Math.floor(e.value))+" in "+gf.data.properties.cycle);break;case"donors":$("#node-title").html(e.title+' <span class="sector '+e.sitecode+'">'+e.sitecode+"</span>");$("#node-amount").html("Contributed $"+commas(Math.floor(e.value))+" to the "+gf.data.properties.state+" "+$("#chamber :selected").text()+" in "+gf.data.properties.cycle)}var r=(remotecache?remotecache+"../":"")+"request.php";$("#node-csvlink a").attr("href",r+"?method=csv&type="+e.type+"&id="+e.id+"&state="+gf.data.properties.state+"&chamber="+gf.data.properties.chamber);t.slideDown(500);$("#masthead").hide()}else resetGraph()}function resetGraph(){$("#infocard").slideUp();$("#masthead").fadeIn(2e3);gf.zoom("reset")}function drawBarChart(e,t){var n=$(window).width()/2*.9,r=$(window).height()/2*.675,i=d3.scale.linear().domain([0,e.length]).range([0,n]),s=d3.scale.linear().domain([0,d3.max(e,function(e){return parseInt(e.value)})]).rangeRound([0,r*.8]),o=d3.select(t+" svg");o.empty()&&(o=d3.select(t).append("svg").attr("width",n).attr("height",r));var u=o.selectAll(".bar").data(e,function(e){return e.label});u.enter().append("rect").attr("class","bar").attr("x",function(e,t){return i(t)}).attr("y",function(e){return r}).attr("width",function(){return n/e.length*.9}).attr("height",function(e){return 0});u.transition().duration(1e3).attr("x",function(e,t){return i(t)}).attr("y",function(e){return r-s(e.value)}).attr("height",function(e){return s(e.value)}).attr("width",function(){return n/e.length*.9});u.exit().transition().duration(1e3).attr("y",function(e){return r}).remove();var a=o.selectAll(".amount").data(e,function(e){return e.label});a.enter().append("text").attr("class","chart-label amount");a.transition().duration(1e3).attr("x",function(t,r){return i(r)+n/e.length*.9/2}).attr("y",function(e){return r-s(e.value)}).attr("dy","-2em").attr("width",function(){return n/e.length}).attr("text-anchor","middle").text(function(e){return"$"+commas(Math.floor(e.value))});a.exit().remove();var f=o.selectAll(".year").data(e,function(e){return e.label});f.enter().append("text").attr("class","chart-label year");f.transition().duration(1e3).attr("x",function(t,r){return i(r)+n/e.length*.9/2}).attr("y",function(e){return r}).attr("dy","-0.5em").attr("width",function(){return n/e.length}).attr("text-anchor","middle").text(function(e){return e.label});f.exit().remove()}function drawPieChart(e,t){function h(){path=l.datum(e).selectAll("path").data(u,d);path.transition().duration(750).attrTween("d",p).attr("fill",function(e,t){return n[e.data.label][1]});l.datum(e).selectAll("text").data(u,d).attr("transform",function(e){return"translate("+a.centroid(e)+")"+"rotate("+f(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return n[e.data.label][0]})}function p(e){var t=d3.interpolate(this._current,e);this._current=t(0);return function(e){return a(t(e))}}function d(e){var t=typeof e.label!="undefined"?e.label:e.data.label;t=="coal"?t="D":t=="oil"?t="R":t=="carbon"&&(t="N");return t}var n={oil:["Oil","#6D8F9D"],coal:["Coal","#958D63"],carbon:["Carbon","#6E6E6E"],R:["Republican","#cc3333"],D:["Democrat","#3333cc"],G:["Green","#33cc33"],L:["Libertarian","#cc33cc"],I:["Independant","#cccc33"],N:["Non-Partisan","#cccccc"]},r=$(window).width()/2*.9,i=$(window).height()/2*.675,s=Math.min(r,i)/2,o=d3.scale.category20(),u=d3.layout.pie().value(function(e){return e.value}).sort(d),a=d3.svg.arc().innerRadius(s*.25).outerRadius(s*1),f=function(e){var t=180/Math.PI*(e.startAngle+e.endAngle)/2-90;t>90&&(t-=180);return t},l=d3.select(t+" svg>g");l.empty()&&(l=d3.select(t).append("svg").attr("width",r).attr("height",i).append("g").attr("transform","translate("+r/2+","+i/2+")"));var c=l.datum(e).selectAll(".arc").data(u,d).enter().append("g").attr("class","arc");c.append("path").attr("fill",function(e,t){return n[e.data.label][1]}).attr("d",a).each(function(e){this._current=e}).on("mouseenter",brighten).on("mouseleave",darken);c.append("text").attr("class","chart-label").attr("transform",function(e){return"translate("+a.centroid(e)+")"+"rotate("+f(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){return e.data.label});l.datum(e).selectAll("path").data(u,d).exit().transition(750).attr("fill","#fff");l.datum(e).selectAll(".arc").data(u,d).exit().transition(750).remove();h()}function brighten(){var e=d3.select(this);e.attr("fill",d3.rgb(e.attr("fill")).brighter(.7))}function darken(){var e=d3.select(this);e.attr("fill",d3.rgb(e.attr("fill")).darker(.7))}function commas(e){while(/(\d+)(\d{3})/.test(e.toString()))e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}function setupOptions(){var e=$.map(states,function(e,t){return t}).sort(),t=$("#state").val();$("#state").html("");$(e).each(function(e,t){$("#state").append($("<option>").attr("value",t).html(states[t].name))});$("#state").val(t);$("#state").on("change",function(e,t,n,r){var i=states[e.target.value],s=$("#cycle").val(),o=$("#chamber").val();$("#chamber").html("");$("#chamber").append($("<option>").attr("value","state:upper").html(i.upper_name));i.lower_name&&$("#chamber").append($("<option>").attr("value","state:lower").html(i.lower_name));$("#cycle").html("");$(i.years.split(",").reverse()).each(function(e,t){$("#cycle").append($("<option>").html(t))});$("#cycle").val(s);$("#chamber").val(o)});$("#state").change()}$(function(){$("#close_error").click(function(){$("#error").hide()});if(!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")){$("#error").html("<h3>Unsupported Browser</h3> We're sorry - this website requires SVG, and it appears your web browser does not support it. Please consider updating to a modern, standards-compliant web browser, such as <a href='http://mozilla.org/firefox'>FireFox</a> or <a href='http://google.com/chrome'>Chrome</a>").show();return}setupOptions();initGraph();$("#infocard").hide();$("#infocard .close").click(function(){resetGraph()});$("#infocard .more").click(function(){$(this).parent().toggleClass("open")});$("#pull").click(function(e){$(".navlist").slideToggle();e.preventDefault()});$(window).resize(function(){$(window).width()>320&&$(".navlist").is(":hidden")&&$(".navlist").removeAttr("style")})});$.extend(NodeViz.prototype,{graphLoaded:function(){$("#infocard").hide();$("#masthead").fadeIn(2e3);gf.nodeList=$.map(gf.data.nodes,function(e){return{label:e.title,value:e.id,search_label:e.title}});$("#node_search").keypress(function(e){var t=e.keyCode?e.keyCode:e.which;if(t==13){$("#node_search").autocomplete("search");return!1}});$("#node_search").autocomplete({source:gf.nodeList,autoFocus:!0,appendTo:"#node_search_list",select:function(e,t){$("#node_search").val(t.item.search_label);selectNode(gf.data.nodes[t.item.value]);return!1},response:function(e,t){t.content.length==0?$("#no_results_found").show():$("#no_results_found").hide()}}).data("ui-autocomplete")._renderItem=function(e,t){var n=gf.data.nodes[t.value],r,i=$("<li>");if(n.type=="candidates"){i.addClass("politician");r=n.title+" <span class='"+n.party+" searchdetails'>("+n.party+" "+n.district+")</span>"}else{i.addClass("company");r="<span>"+n.title+" <span class='"+n.sitecode+" searchdetails'>("+toWordCase(n.sitecode)+")</span></span>"}return i.append("<a>"+r+"</a>").appendTo(e)}}});GraphImage.prototype.pre_render=function(e){e.overlay=e.overlay.replace(/com_images/g,"http://dirtyenergymoney.com/com_images")};NodeViz.prototype.default_events.edge.click=null;NodeViz.prototype.default_events.node.click=function(e,t,n,r,i){selectNode(n)};$.extend(GraphList.prototype,{listNodeEntry:function(e){var t,n="";e.title?t=e.title:t=e.id;var r="",i="<span class='chip "+(typeof e.party!="undefined"?e.party:"contrib_"+e.contributor_type)+"'></span>",s=typeof e.image!="undefined"&&e.image!="null"?"<img src='"+e.image+"' style='width: 20px; border: 1px solid #666;'/>":"";if(e.type=="candidates"){if(e.party){r="<span class='info'>"+e.party+"</span>";r+="<div class='details'>					<a class='profile_link' href='?candidate_ids="+e.id+"'><img class='link_icon' src='images/go-next.png'/>Profile</a>					<a class='nimsp_link' href='http://www.followthemoney.org/database/uniquecandidate.phtml?uc="+e.unique_candidate_id+"' target='_new'><img class='link_icon' src='images/go-next.png'/>NIMSP Profile</a>				</div>"}}else{var o="Unknown";e.industry!="--"&&(o=e.industry);r+="<a class='profile_link' href='?company_ids="+e.id+"'><img class='link_icon' src='images/go-next.png'/>Profile</a>";r+="<span class='industry'>"+o+"</span><br style='clear:both'/>"}return s+"<span class='label'>"+t+"</span><span class='amount'>$"+format(Math.round(e.total_dollars))+"</span><br/>"+i+r},listSubNodeEntry:function(e,t,n,r){var i,s=r=="to"?"to_node_item":"from_node_item";e.title?i=e.title:i=e.id;var o="Uncategorized",u=this.NodeViz.data.edges[e.relatedNodes[t.id][0]];e.type=="candidates"?e.party&&(o=e.party):e.contributor_type&&(e.contributor_type=="I"?o="Individual":e.contributor_type=="C"&&(o="PAC"));o="<span class='info'>"+o+"</span>";var a="<span class='chip "+(typeof e.party!="undefined"?e.party:"contrib_"+e.contributor_type)+"'></span>",f="<span class='details_link'><img src='NodeViz/icons/magnifier.png' alt='View Details' title='View Details'/></span>";return"<span class='"+s+" label' onclick=\"gf.selectNode('"+e.id+"'); gf.panToNode('"+e.id+"');\">"+i+"</span><span class='amount'>$"+format(Math.round(u.value))+"</span><br/>"+a+o+f},sublistHeader:function(e,t,n){var r="Recipients";n=="to"&&(r="Donors");return"<div class='sublist_header'>"+r+"</div>"}});