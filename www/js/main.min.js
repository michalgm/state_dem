// Document Ready
function initGraph(){var e=$.url().param();$(e).keys().each(function(t,n){$("#graphoptions").append($("<input>").attr({type:"hidden",name:n,value:e[n]}))});$("#graphoptions").change(writeHash);var t={setupfile:"StateDEM",disableAutoLoad:1,image:{graphdiv:"graphs",zoomlevels:"8",zoomSliderAxis:"vertical",fadeTo:.2,center_tooltip:1,tooltipOffsetY:-21,tooltipOffsetX:0},list:{listdiv:"lists",sort:{candidates:[{label:"Name",sort_values:["lastfirst"]},{label:"Amount",sort_values:["value"]}],donors:[{label:"Name",sort_values:["title"]},{label:"Amount",sort_values:["value"]}]},scrollList:1},functions:{}};remotecache&&(t.NodeVizPath=remotecache);gf=new NodeViz(t);$("#graphoptions").change($.proxy(gf.reloadGraph,gf))}function updateInfocardData(e){var t=(remotecache?remotecache+"../":"")+"request.php";$.getJSON(t,{method:"chartData",type:e.type,id:e.id,state:gf.data.properties.state,chamber:gf.data.properties.chamber},function(e,t,n){barChart.draw(e.contributionsByYear);var r=0;$.each(e.contributionsByYear,function(e,t){r+=t.value});$("#node-total").html("Total: $"+commas(r))})}function selectNode(e){gf.selectNode(e.id);current_network=e.id;writeHash(1);toggleInfocard(e)}function toggleInfocard(e){var t=$("#infocard"),n=t.data("data-node");updateInfocardData(e);if(t.is(":hidden")||n!==e.id){t.data("data-node",e.id);switch(e.type){case"candidates":$("#node-title").html(e.title+' <span class="district '+e.party+'">'+e.district+"</span>");$("#node-amount").html("Received $"+commas(Math.floor(e.value))+" in "+gf.data.properties.cycle);break;case"donors":$("#node-title").html(e.title+' <span class="sector '+e.sitecode+'">'+e.sitecode+"</span>");$("#node-amount").html("Contributed $"+commas(Math.floor(e.value))+" to the "+gf.data.properties.state+" "+$("#chamber :selected").text()+" in "+gf.data.properties.cycle)}var r=(remotecache?remotecache+"../":"")+"request.php";$("#node-csvlink a").attr("href",r+"?method=csv&type="+e.type+"&id="+e.id+"&state="+gf.data.properties.state+"&chamber="+gf.data.properties.chamber).find("span").html(e.type.slice(0,-1));var i=e.twitter?'<a class="twitter" href="'+e.twitter+'">Twitter</a>':"";i+=e.facebook?'<a class="facebook" href="'+e.facebook+'">Facebook</a>':"";i+=e.action_link?'<a class="action" href="'+e.action_link+'">Take Action</a>':"";$("#node-links").html(i);t.slideDown(500);gf.panToNode(e.id,null,{y:-50,x:0});$("#legend").hide()}else resetGraph()}function toggleMore(){$("#infocard").toggleClass("open");$("#node-amount, .node-more").fadeToggle()}function togglePage(e){var t=$(e).attr("href")||"";$(".page").not(t).slideUp();$(t).slideToggle()}function toggleLists(){var e=$("#lists-container"),t=$("#graphs-container"),n=function(){barChart.resize();gf.resize()};if(parseInt(e.css("width"))>0){e.animate({width:"0%"},500);t.animate({width:"100%"},500,n)}else{e.animate({width:"33%"},500);t.animate({width:"67%"},500,n)}e.toggleClass("open")}function resetGraph(){$("#infocard").removeClass("open").slideUp(500,function(){$("#node-amount").show();$(".node-more").hide();current_network="";gf.current.network&&gf.unselectNode(1);gf.zoom("reset")});$("#legend").fadeIn(2e3)}function writeHash(e){var t={state:$("#state").val(),chamber:toWordCase($("#chamber").val().replace("state:","")),cycle:$("#cycle").val()},n=[t.state,t.chamber,t.cycle];if(e==1){t.network=gf.current.network;n.push(t.network)}else current_network="";History.pushState(t,"Dirty Energy Money - States - "+$("#state option:selected").text(),"?"+n.join("/"))}function setState(){var e=History.getState().data;if(!e.state)resetGraph();else{e.chamber="state:"+e.chamber.toLowerCase();if($("#state").val()!=e.state||$("#chamber").val()!=e.chamber||$("#cycle").val()!=e.cycle){$("#state").val(e.state);$("#chamber").val(e.chamber);$("#cycle").val(e.cycle);$("#state").change()}else if(current_network!=e.network||!e.network)if(!e.network&&current_network)resetGraph();else if(e.network&&gf.data.nodes[e.network]){current_network=e.network;$("#"+e.network).click()}}}function setupOptions(){var e=$.map(states,function(e,t){return t}).sort(),t=$("#state").val();$("#state").html("");$(e).each(function(e,t){$("#state").append($("<option>").attr("value",t).html(states[t].name));$("#intro_state").append($("<option>").attr("value",t).html(states[t].name))});$("#state").val(t);$("#state").on("change",function(){updateOptions()});$("#chamber").on("change",function(){updateCycle()})}function updateOptions(){var e=states[$("#state").val()],t=$("#chamber").val();$("#chamber").html("");$("#chamber").append($("<option>").attr("value","state:upper").html(e.upper_name));e.lower_name&&$("#chamber").append($("<option>").attr("value","state:lower").html(e.lower_name));$("#chamber").append($("<option>").attr("value","state:all").html("All"));$("#chamber").append($("<option>").attr("value","state:governor").html("Governor"));$("#chamber").val(t);updateCycle()}function updateCycle(){var e=states[$("#state").val()],t=$("#cycle").val(),n=$("#chamber").val();$("#cycle").html("");$(e.years.split(",").reverse()).each(function(e,t){$("#cycle").append($("<option>").html(t))});n!="state:all"&&$("#cycle").append($("<option>").attr("value","all").html("All"));if(n=="state:governor"){$("#cycle").val("all");$("#cycle").hide()}else{$("#cycle").show();$("#cycle").val(t)}}function setupAutocomplete(){gf.nodeList=$.map(gf.data.nodes,function(e){return{label:e.title,value:e.id,search_label:e.title}});$("#node_search").keyup(function(e){$("#node_search").val()==""&&$("#no_results_found").hide()});$("#node_search").keypress(function(e){var t=e.keyCode?e.keyCode:e.which;if(t==13){if($("#node_search").val().length){$("#node_search").autocomplete("search");$("#node_search").autocomplete("close")}return!1}$("#node_search").val()==""&&$("#no_results_found").hide()});$("#node_search").autocomplete({source:gf.nodeList,autoFocus:!0,appendTo:"#node_search_list",select:function(e,t){$("#node_search").val(t.item.search_label);selectNode(gf.data.nodes[t.item.value]);$("#node_search").autocomplete("close");return!1},response:function(e,t){t.content.length==0&&$("#node_search").val().length?$("#no_results_found").show():$("#no_results_found").hide()}}).data("ui-autocomplete")._renderItem=function(e,t){var n=gf.data.nodes[t.value],r,i=$("<li>");if(n.type=="candidates"){i.addClass("politician");r=n.title+" <span class='"+n.party+" searchdetails'>("+n.party+" "+n.district+")</span>"}else{i.addClass("company");r="<span>"+n.title+" <span class='"+n.sitecode+" searchdetails'>("+toWordCase(n.sitecode)+")</span></span>"}return i.append("<a>"+r+"</a>").appendTo(e)}}$(function(){current_network="";$("#close_error").click(function(){$("#error").hide()});if(!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")){$("#error").html("<h3>Unsupported Browser</h3> We're sorry - this website requires SVG, and it appears your web browser does not support it. Please consider updating to a modern, standards-compliant web browser, such as <a href='http://mozilla.org/firefox'>FireFox</a> or <a href='http://google.com/chrome'>Chrome</a>").show();return}setupOptions();History.Adapter.bind(window,"statechange",setState);initGraph();$("#infocard .close").click(function(){resetGraph()});$("#infocard .more").click(function(){toggleMore()});$("#lists-container .toggle").click(function(){toggleLists()});$(".aboutLink, .methodologyLink, .page-close").click(function(){togglePage(this)});$("#pull").click(function(e){$(".navlist").slideToggle();e.preventDefault()});$(window).resize($.debounce(100,function(){$(window).width()>320&&$(".navlist").is(":hidden")&&$(".navlist").removeAttr("style");barChart.resize()}));var e=window.location.search.substr(1).split("/");if(e[0]){$("#state").val(e[0]);updateOptions();$("#chamber").val("state:"+e[1].toLowerCase());updateOptions();$("#cycle").val(e[2]);$("#intro_screen").hide();$("#state").change();e[3]&&(current_network=e[3])}else{$("#intro_screen").show();$("#graphoptions select").hide()}$("#intro_state").change(function(e){$("#state").val($("#intro_state").val());var t=$("#intro_screen").offset();t.margin=0;$("#intro_screen").css(t).animate({height:0,width:"20px",top:$("#navbar").position().top,left:0},250,function(){$(this).hide();$("#state").change()});$("#graphoptions select").fadeIn();$("#masthead").fadeOut()});barChart=new DEMBarChart("#node-barchart")});$.extend(NodeViz.prototype,{graphLoaded:function(){$("#content").removeClass("initial");$(".cluster").remove();$(".zerocontribs").remove();gf.data.nodes.zerocontribs&&delete gf.data.nodes.zerocontribs;$.each($(".zero"),function(e,t){gf.data.nodes[t.id]&&(gf.data.nodes[t.id].relatedNodes={})});$("#infocard").hide();$("#masthead").fadeOut(2e3);$("#about, #methodology").slideUp();$("#navbar").slideDown();$("#lists-container, #searchfield").show();$("#graphoptions select").blur();$("#legend-text").html("Contributions to the "+gf.data.properties.state+" "+$("#chamber :selected").text()+" in "+gf.data.properties.cycle+", scaled by amount.");$("#csvlink").hide().attr("href",function(){var e=(remotecache?remotecache+"../":"")+"request.php";return e+"?method=csv&type=chamber&state="+gf.data.properties.state+"&chamber="+gf.data.properties.chamber+"&cycle="+gf.data.properties.cycle}).delay(1e3).fadeIn();setupAutocomplete();$(".node_search_container").hide();$(".nodelist_header").show();current_network&&gf.data.nodes[current_network]?$("#"+current_network).click():$("#chamber").val()=="state:governor"&&$("#"+gf.data.nodetypesindex.candidates[0]).click()}});$.extend(GraphList.prototype,{listNodeEntry:function(e){var t=e.title?e.title:e.id,n=typeof e.image!="undefined"&&e.image!="null"?"<img src='"+e.image+"'>":"",r=e.total_dollars>0?"$"+format(Math.round(e.total_dollars)):"none",i;e.type=="candidates"?i=e.party?e.party:"":i=e.sitecode?e.sitecode:"";var s='<div class="thumb">'+n+"</div>";s+='<div class="title">'+t+' <span class="label '+i+'">'+i+"</span></div>";s+='<div class="amount">'+r+"</div>";return s},listSubNodeEntry:function(e,t,n,r){var i=e.title?e.title:e.id,s=this.NodeViz.data.edges[e.relatedNodes[t.id][0]],o=e.total_dollars>0?"$"+format(Math.round(s.value)):"none",u='<div class="title">'+i+"</div>";u+='<div class="amount">'+o+"</div>";return u;var a,f,l,s,c,h},listHeader:function(e){return""},sublistHeader:function(e,t,n){var r="Recipients";n=="to"&&(r="Donors");return"<div class='sublist_header'>"+r+"</div>"},pre_render:function(){$.each(this.NodeViz.data.nodes,function(e,t){t.image&&(t.image=t.image.replace(/..\/www\//,""))})}});GraphImage.prototype.pre_render=function(e){$.each(this.NodeViz.data.nodes,function(e,t){t.image&&(t.image=t.image.replace(/..\/www\//,""))})};NodeViz.prototype.default_events.edge.click=null;NodeViz.prototype.default_events.node.click=function(e,t,n,r,i){selectNode(n)};